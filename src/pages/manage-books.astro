---
import BaseLayout from "../layouts/BaseLayout.astro";
import TypeWriter from "../components/TypeWriter.tsx";
---

<BaseLayout title="Manage Books | My Portfolio">
  <section class="py-12 max-w-4xl mx-auto">
    <div data-scroll class="opacity-0 text-center mb-12">
      <h1 class="text-3xl md:text-4xl font-bold mb-6 min-h-[3.5rem]">
        <TypeWriter 
          client:load 
          text="Manage My Books" 
          speed={100} 
          delay={300}
          className="bg-gradient-to-r from-primary-accent to-secondary-accent bg-clip-text text-transparent"
        />
      </h1>
      <div class="w-24 h-1 bg-gradient-to-r from-primary-accent to-secondary-accent mx-auto mb-6"></div>
    </div>

    <!-- Add Book Form -->
    <div data-scroll data-scroll-delay="0.1" class="opacity-0 bg-base-200 rounded-xl p-8 shadow-lg mb-8">
      <h2 class="text-xl font-bold mb-6 text-primary-accent flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        Add New Book
      </h2>
      
      <form id="addBookForm" class="space-y-6">
        <!-- Basic Info -->
        <div class="grid md:grid-cols-2 gap-6">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                Book Title
              </span>
            </label>
            <input 
              type="text" 
              name="title" 
              placeholder="Enter book title..." 
              class="input input-bordered w-full" 
              required 
            />
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Author
              </span>
            </label>
            <input 
              type="text" 
              name="author" 
              placeholder="Author name..." 
              class="input input-bordered w-full" 
              required 
            />
          </div>
        </div>

        <!-- Description -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
              </svg>
              Description
            </span>
          </label>
          <textarea 
            name="description" 
            placeholder="Brief description of the book..." 
            class="textarea textarea-bordered h-24"
            required
          ></textarea>
        </div>

        <!-- Book Details -->
        <div class="grid md:grid-cols-4 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                </svg>
                Genre
              </span>
            </label>
            <select name="genre" class="select select-bordered w-full" required>
              <option disabled selected>Select genre</option>
              <option value="Programming">Programming</option>
              <option value="JavaScript">JavaScript</option>
              <option value="Web Development">Web Development</option>
              <option value="Software Engineering">Software Engineering</option>
              <option value="Computer Science">Computer Science</option>
              <option value="Design">Design</option>
              <option value="Business">Business</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Year
              </span>
            </label>
            <input 
              type="number" 
              name="year" 
              placeholder="2024" 
              min="1900" 
              max="2030"
              class="input input-bordered w-full" 
              required 
            />
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Pages
              </span>
            </label>
            <input 
              type="number" 
              name="pages" 
              placeholder="300" 
              min="1"
              class="input input-bordered w-full" 
              required 
            />
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                </svg>
                Rating
              </span>
            </label>
            <select name="rating" class="select select-bordered w-full" required>
              <option disabled selected>Rate it</option>
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 stars)</option>
              <option value="3">‚≠ê‚≠ê‚≠ê (3 stars)</option>
              <option value="2">‚≠ê‚≠ê (2 stars)</option>
              <option value="1">‚≠ê (1 star)</option>
            </select>
          </div>
        </div>

        <!-- Date Read -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              Date Read
            </span>
          </label>
          <input 
            type="date" 
            name="dateRead" 
            class="input input-bordered w-full md:w-64" 
            required 
          />
        </div>

        <!-- Enhanced File Uploads with Auto-Extract -->
        <div class="space-y-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                PDF File
              </span>
            </label>
            <input 
              type="file" 
              name="pdfFile" 
              accept=".pdf"
              class="file-input file-input-bordered w-full" 
              required 
              id="pdfFileInput"
            />
            <div class="label">
              <span class="label-text-alt">Upload PDF and click "Extract Info" to auto-fill book details</span>
            </div>
          </div>
          
          <!-- Extract Button - Separate Row -->
          <div class="flex justify-center">
            <button 
              type="button" 
              id="extractButton"
              class="btn btn-outline btn-secondary btn-wide flex items-center gap-2"
              onclick="window.handlePdfExtraction()"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              Extract Info
            </button>
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Cover Image (Optional)
              </span>
            </label>
            <input 
              type="file" 
              name="coverFile" 
              accept="image/*"
              class="file-input file-input-bordered w-full" 
            />
            <div class="label">
              <span class="label-text-alt">If not provided, will auto-generate from PDF</span>
            </div>
          </div>
        </div>

        <!-- My Thoughts -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
              </svg>
              My Thoughts & Takeaways
            </span>
          </label>
          <textarea 
            name="myThoughts" 
            placeholder="Share your thoughts, key learnings, favorite quotes, etc..."
            class="textarea textarea-bordered h-32"
            required
          ></textarea>
          <div class="label">
            <span class="label-text-alt">Write your review, insights, and key takeaways</span>
          </div>
        </div>

        <!-- Tags -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
              Tags
            </span>
          </label>
          <input 
            type="text" 
            name="tags" 
            placeholder="programming, javascript, clean-code, best-practices" 
            class="input input-bordered w-full" 
            required 
          />
          <div class="label">
            <span class="label-text-alt">Comma-separated tags for categorization</span>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-center pt-6">
          <button 
            type="submit" 
            class="btn btn-primary btn-lg group relative overflow-hidden"
            id="submitButton"
          >
            <span id="submitText" class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14,2 14,8 20,8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10,9 9,9 8,9"></polyline>
              </svg>
              Add Book to Collection
            </span>
            <span id="loadingSpinner" class="loading loading-spinner loading-md hidden"></span>
          </button>
        </div>
      </form>
    </div>

    <!-- Success/Error Messages -->
    <div id="successMessage" data-scroll data-scroll-delay="0.2" class="opacity-0 mt-8 p-6 bg-success/10 border border-success/30 rounded-xl text-center hidden">
      <h3 class="text-xl font-bold text-success mb-2 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Book Added Successfully!
      </h3>
      <p>Your book has been added to your collection and is now available on your books page.</p>
      <div class="flex gap-4 justify-center mt-4">
        <button id="addAnother" class="btn btn-outline btn-success">Add Another Book</button>
        <a href="/books" class="btn btn-primary">View Collection</a>
      </div>
    </div>

    <div id="errorMessage" data-scroll data-scroll-delay="0.2" class="opacity-0 mt-8 p-6 bg-error/10 border border-error/30 rounded-xl text-center hidden">
      <h3 class="text-xl font-bold text-error mb-2">‚ùå Something went wrong</h3>
      <p id="errorText">There was an error adding your book. Please try again.</p>
      <button id="tryAgain" class="btn btn-outline btn-error mt-4">Try Again</button>
    </div>
  </section>

  <script>
    import { uploadFile, addBook } from '../utils/firebaseConfig';

    // Global variables to store extracted data
    let extractedMetadata = null;
    let selectedPdfFile = null;

    // Load PDF.js library
    function loadPdfJs() {
      return new Promise((resolve) => {
        if ((window as any).pdfjsLib) {
          resolve(true);
          return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        script.onload = () => {
          (window as any).pdfjsLib.GlobalWorkerOptions.workerSrc = 
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
          resolve(true);
        };
        document.head.appendChild(script);
      });
    }

    // Handle PDF extraction button click - Make it globally accessible
    async function handlePdfExtraction() {
      const fileInput = document.getElementById('pdfFileInput') as HTMLInputElement;
      const file = fileInput.files?.[0];
      
      if (!file || file.type !== 'application/pdf') {
        showNotification('Please select a PDF file first', 'warning');
        return;
      }

      selectedPdfFile = file;
      
      try {
        // Show loading indicator
        const extractBtn = document.getElementById('extractButton');
        if (extractBtn) {
          extractBtn.textContent = 'Extracting...';
          extractBtn.classList.add('loading', 'loading-spinner');
        }
        
        // Ensure PDF.js is loaded
        await loadPdfJs();
        
        // Extract metadata from local file
        extractedMetadata = await extractPdfMetadata(file);
        const description = await generateBookDescription(extractedMetadata.extractedText, extractedMetadata.title);
        
        // Auto-fill form fields
        const form = document.getElementById('addBookForm') as HTMLFormElement;
        if (form) {
          (form.querySelector('[name="title"]') as HTMLInputElement).value = extractedMetadata.title;
          (form.querySelector('[name="author"]') as HTMLInputElement).value = extractedMetadata.author;
          (form.querySelector('[name="description"]') as HTMLTextAreaElement).value = description;
          (form.querySelector('[name="pages"]') as HTMLInputElement).value = extractedMetadata.pages.toString();
          (form.querySelector('[name="year"]') as HTMLInputElement).value = extractedMetadata.year.toString();
          
          // Set some smart defaults
          const genreSelect = form.querySelector('[name="genre"]') as HTMLSelectElement;
          const titleLower = extractedMetadata.title.toLowerCase();
          if (titleLower.includes('javascript')) {
            genreSelect.value = 'JavaScript';
          } else if (titleLower.includes('programming') || titleLower.includes('code')) {
            genreSelect.value = 'Programming';
          } else if (titleLower.includes('web') || titleLower.includes('html') || titleLower.includes('css')) {
            genreSelect.value = 'Web Development';
          } else {
            genreSelect.value = 'Programming'; // Default
          }
          
          // Generate smart tags
          const tags = generateSmartTags(extractedMetadata.title, extractedMetadata.author, description);
          (form.querySelector('[name="tags"]') as HTMLInputElement).value = tags.join(', ');
          
          // Set default rating
          (form.querySelector('[name="rating"]') as HTMLSelectElement).value = '4';
        }
        
        // Show success message
        if (extractBtn) {
          extractBtn.textContent = '‚úÖ Extracted!';
          extractBtn.classList.remove('loading', 'loading-spinner');
        }
        
        // Show notification
        showNotification('üìö Book information extracted successfully!', 'success');
        
      } catch (error) {
        console.error('Error extracting PDF metadata:', error);
        showNotification('‚ö†Ô∏è Could not extract all info, please fill manually', 'warning');
        
        const extractBtn = document.getElementById('extractButton');
        if (extractBtn) {
          extractBtn.textContent = 'Extract Info';
          extractBtn.classList.remove('loading', 'loading-spinner');
        }
      }
    }

    // Extract PDF metadata from local file
    async function extractPdfMetadata(file: File) {
      try {
        if (typeof window !== 'undefined' && (window as any).pdfjsLib) {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await (window as any).pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          
          // Get basic info
          const numPages = pdf.numPages;
          const metadata = await pdf.getMetadata();
          
          // Extract text from first few pages for title/author detection
          let extractedText = '';
          const pagesToCheck = Math.min(3, numPages); // Check first 3 pages
          
          for (let i = 1; i <= pagesToCheck; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map((item: any) => item.str).join(' ');
            extractedText += pageText + ' ';
          }
          
          // Try to extract title and author from metadata or text
          const title = metadata.info?.Title || extractTitleFromText(extractedText) || file.name.replace('.pdf', '');
          const author = metadata.info?.Author || extractAuthorFromText(extractedText) || 'Unknown Author';
          const subject = metadata.info?.Subject || '';
          
          // Try to extract year from metadata or text
          const creationDate = metadata.info?.CreationDate;
          let year = new Date().getFullYear();
          if (creationDate) {
            const dateMatch = creationDate.match(/D:(\d{4})/);
            if (dateMatch) {
              year = parseInt(dateMatch[1]);
            }
          } else {
            const yearFromText = extractYearFromText(extractedText);
            if (yearFromText) year = yearFromText;
          }
          
          return {
            title: cleanTitle(title),
            author: cleanAuthor(author),
            pages: numPages,
            year: year,
            subject: subject,
            extractedText: extractedText.substring(0, 500) // First 500 chars for description
          };
        }
        
        throw new Error('PDF.js not loaded');
      } catch (error) {
        console.error('Error extracting PDF metadata:', error);
        
        // Fallback: use filename
        const fallbackTitle = file.name.replace('.pdf', '').replace(/[-_]/g, ' ');
        return {
          title: fallbackTitle,
          author: 'Unknown Author',
          pages: 100, // Default fallback
          year: new Date().getFullYear(),
          subject: '',
          extractedText: ''
        };
      }
    }

    // Helper functions for text extraction
    function extractTitleFromText(text: string): string | null {
      // Look for common title patterns
      const lines = text.split('\n').filter(line => line.trim().length > 0);
      
      // Usually the title is one of the first few lines and is often longer
      for (let i = 0; i < Math.min(5, lines.length); i++) {
        const line = lines[i].trim();
        if (line.length > 10 && line.length < 100 && !line.includes('@')) {
          return line;
        }
      }
      
      return null;
    }

    function extractAuthorFromText(text: string): string | null {
      // Look for common author patterns
      const authorPatterns = [
        /by\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/i,
        /author:\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/i,
        /written\s+by\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/i
      ];
      
      for (const pattern of authorPatterns) {
        const match = text.match(pattern);
        if (match) {
          return match[1];
        }
      }
      
      return null;
    }

    function extractYearFromText(text: string): number | null {
      // Look for 4-digit years (1900-2030)
      const yearPattern = /(19|20)\d{2}/g;
      const matches = text.match(yearPattern);
      
      if (matches) {
        // Return the most recent reasonable year
        const years = matches.map(y => parseInt(y)).filter(y => y >= 1900 && y <= 2030);
        return years.length > 0 ? Math.max(...years) : null;
      }
      
      return null;
    }

    function cleanTitle(title: string): string {
      return title
        .replace(/[^\w\s:.-]/g, '') // Remove special characters except basic punctuation
        .replace(/\s+/g, ' ') // Replace multiple spaces with single space
        .trim()
        .substring(0, 100); // Limit length
    }

    function cleanAuthor(author: string): string {
      return author
        .replace(/[^\w\s.-]/g, '') // Remove special characters except basic punctuation
        .replace(/\s+/g, ' ') // Replace multiple spaces with single space
        .trim()
        .substring(0, 50); // Limit length
    }

    // Generate description from PDF content
    async function generateBookDescription(extractedText: string, title: string): Promise<string> {
      // Simple description generation based on extracted text
      const cleanText = extractedText
        .replace(/\s+/g, ' ')
        .trim()
        .substring(0, 300);
      
      if (cleanText.length > 50) {
        return `${cleanText}...`;
      }
      
      // Fallback descriptions based on title keywords
      const titleLower = title.toLowerCase();
      
      if (titleLower.includes('javascript')) {
        return 'A comprehensive guide to JavaScript programming, covering modern techniques and best practices.';
      } else if (titleLower.includes('react')) {
        return 'Learn React development with practical examples and real-world applications.';
      } else if (titleLower.includes('python')) {
        return 'Master Python programming with this detailed guide covering fundamentals to advanced topics.';
      } else if (titleLower.includes('design')) {
        return 'Explore design principles and patterns for creating better software and user experiences.';
      } else if (titleLower.includes('algorithm')) {
        return 'Deep dive into algorithms and data structures for efficient problem solving.';
      }
      
      return 'A valuable resource for developers looking to expand their knowledge and skills.';
    }

    // Generate smart tags based on content
    function generateSmartTags(title: string, author: string, description: string): string[] {
      const text = (title + ' ' + author + ' ' + description).toLowerCase();
      const tags: string[] = [];
      
      // Programming-related tags
      if (text.includes('javascript')) tags.push('javascript', 'web-development');
      if (text.includes('react')) tags.push('react', 'frontend');
      if (text.includes('node')) tags.push('nodejs', 'backend');
      if (text.includes('python')) tags.push('python', 'programming');
      if (text.includes('typescript')) tags.push('typescript', 'web-development');
      if (text.includes('css')) tags.push('css', 'frontend', 'web-development');
      if (text.includes('html')) tags.push('html', 'frontend', 'web-development');
      if (text.includes('database')) tags.push('database', 'backend');
      if (text.includes('algorithm')) tags.push('algorithms', 'computer-science');
      if (text.includes('design pattern')) tags.push('design-patterns', 'software-architecture');
      if (text.includes('clean code')) tags.push('clean-code', 'best-practices');
      if (text.includes('testing')) tags.push('testing', 'quality-assurance');
      
      // General programming tags
      if (text.includes('programming') || text.includes('coding')) tags.push('programming');
      if (text.includes('software')) tags.push('software-engineering');
      if (text.includes('web')) tags.push('web-development');
      if (text.includes('mobile')) tags.push('mobile-development');
      if (text.includes('data')) tags.push('data-science');
      
      // Remove duplicates and limit to 5 tags
      return [...new Set(tags)].slice(0, 5);
    }

    // Show notification
    function showNotification(message: string, type: 'success' | 'warning' | 'error') {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type} fixed top-4 right-4 z-50 max-w-sm shadow-lg`;
      notification.innerHTML = `
        <div>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Auto-remove after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Set default date to today and make function globally accessible
    document.addEventListener('DOMContentLoaded', async () => {
      // Load PDF.js early
      await loadPdfJs();
      
      const dateInput = document.querySelector('input[name="dateRead"]');
      if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
      }

      // Make function globally accessible
      (window as any).handlePdfExtraction = handlePdfExtraction;
    });

    // Handle form submission
    document.getElementById('addBookForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const submitButton = document.getElementById('submitButton') as HTMLButtonElement;
      const submitText = document.getElementById('submitText') as HTMLSpanElement;
      const loadingSpinner = document.getElementById('loadingSpinner') as HTMLSpanElement;
      const successMessage = document.getElementById('successMessage') as HTMLDivElement;
      const errorMessage = document.getElementById('errorMessage') as HTMLDivElement;
      const errorText = document.getElementById('errorText') as HTMLParagraphElement;

      try {
        // Show loading state
        submitButton.disabled = true;
        submitText.textContent = "Adding book...";
        loadingSpinner.classList.remove("hidden");
        errorMessage.classList.add('hidden');

        // Get form values
        const title = formData.get('title') as string;
        const author = formData.get('author') as string;
        const description = formData.get('description') as string;
        const genre = formData.get('genre') as string;
        const year = parseInt(formData.get('year') as string);
        const pages = parseInt(formData.get('pages') as string);
        const rating = parseInt(formData.get('rating') as string);
        const dateRead = formData.get('dateRead') as string;
        const myThoughts = formData.get('myThoughts') as string;
        const tags = (formData.get('tags') as string).split(',').map(tag => tag.trim()).filter(tag => tag);
        
        const pdfFile = formData.get('pdfFile') as File;
        const coverFile = formData.get('coverFile') as File;

        if (!pdfFile || pdfFile.size === 0) {
          throw new Error('Please select a PDF file');
        }

        // Use extracted metadata if available, otherwise use form data
        const finalTitle = extractedMetadata?.title || title;
        const finalAuthor = extractedMetadata?.author || author;
        const finalPages = extractedMetadata?.pages || pages;
        const finalYear = extractedMetadata?.year || year;

        // Upload PDF file
        console.log('Uploading PDF...');
        const pdfUrl = await uploadFile(pdfFile, `pdfs/${finalTitle.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`);

        // Upload cover image or generate placeholder
        let coverImage = '';
        if (coverFile && coverFile.size > 0) {
          console.log('Uploading cover image...');
          coverImage = await uploadFile(coverFile, `covers/${finalTitle.replace(/[^a-zA-Z0-9]/g, '_')}.jpg`);
        } else {
          // Generate placeholder cover
          coverImage = `data:image/svg+xml;charset=UTF-8,%3Csvg width='240' height='320' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100%25' height='100%25' fill='%23374151'/%3E%3Ctext x='50%25' y='30%25' font-size='16' fill='%23ffffff' text-anchor='middle' dy='.3em'%3Eüìö%3C/text%3E%3Ctext x='50%25' y='50%25' font-size='12' fill='%23ffffff' text-anchor='middle' dy='.3em'%3E${encodeURIComponent(finalTitle.substring(0, 20))}%3C/text%3E%3Ctext x='50%25' y='70%25' font-size='10' fill='%23ffffff' text-anchor='middle' dy='.3em'%3E${encodeURIComponent(finalAuthor)}%3C/text%3E%3C/svg%3E`;
        }

        // Add book to Firestore
        console.log('Adding book to Firestore...');
        const bookId = await addBook({
          title: finalTitle,
          author: finalAuthor,
          coverImage,
          pdfUrl,
          description,
          genre,
          year: finalYear,
          pages: finalPages,
          myThoughts,
          rating,
          dateRead,
          tags
        });

        console.log('Book added successfully with ID:', bookId);

        // Show success message
        form.classList.add('hidden');
        successMessage.classList.remove('hidden');

      } catch (error) {
        console.error('Error adding book:', error);
        
        // Show error message
        errorText.textContent = error.message || 'There was an error adding your book. Please try again.';
        errorMessage.classList.remove('hidden');
      } finally {
        // Reset button state
        submitButton.disabled = false;
        submitText.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14,2 14,8 20,8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10,9 9,9 8,9"></polyline>
          </svg>
          Add Book to Collection
        `;
        loadingSpinner.classList.add("hidden");
      }
    });

    // Handle "Add Another Book" button
    document.getElementById('addAnother')?.addEventListener('click', () => {
      document.getElementById('addBookForm')?.classList.remove('hidden');
      document.getElementById('successMessage')?.classList.add('hidden');
      document.getElementById('addBookForm')?.reset();
      
      // Reset extracted data
      extractedMetadata = null;
      selectedPdfFile = null;
      
      // Reset date to today
      const dateInput = document.querySelector('input[name="dateRead"]');
      if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
      }
    });

    // Handle "Try Again" button
    document.getElementById('tryAgain')?.addEventListener('click', () => {
      document.getElementById('errorMessage')?.classList.add('hidden');
    });

    // Scroll animations
    document.addEventListener('DOMContentLoaded', () => {
      const scrollElements = document.querySelectorAll('[data-scroll]');
      
      const elementInView = (el, scrollOffset = 0) => {
        const elementTop = el.getBoundingClientRect().top;
        return (
          elementTop <= 
          (window.innerHeight || document.documentElement.clientHeight) * 0.8
        );
      };
      
      const displayScrollElement = (element) => {
        const delay = element.dataset.scrollDelay || 0;
        setTimeout(() => {
          element.style.opacity = 1;
          element.style.transform = 'translateY(0)';
        }, delay * 1000);
      };
      
      const handleScrollAnimation = () => {
        scrollElements.forEach((el) => {
          if (elementInView(el)) {
            displayScrollElement(el);
          }
        });
      };
      
      scrollElements.forEach(el => {
        el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
      });
      
      window.addEventListener('scroll', handleScrollAnimation);
      handleScrollAnimation();
    });
  </script>
</BaseLayout>

<style>
  [data-scroll] {
    opacity: 0;
    transform: translateY(20px);
  }
</style>