---
import BaseLayout from "../layouts/BaseLayout.astro";
import TypeWriter from "../components/TypeWriter.tsx";
import { addLetter } from "../utils/firebaseConfig";
---

<BaseLayout title="Write Me a Letter | My Portfolio">
  <section class="py-12 md:py-16 max-w-2xl mx-auto">
    <div data-scroll class="opacity-0">
      <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 min-h-[3.5rem]">
        <TypeWriter 
          client:load 
          text="Send Me a Note" 
          speed={100} 
          delay={300}
        />
      </h1>
      <div class="w-24 h-1 bg-primary-accent mx-auto mb-6"></div>
      
      <p class="text-center mb-4">I'd love to hear your thoughts - share anything that's on your mind.</p>
      <p class="text-center mb-8 italic text-secondary-accent flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 17a3 3 0 0 1-3-3v-2a3 3 0 1 1 6 0v2a3 3 0 0 1-3 3Z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M7 10V8a5 5 0 1 1 10 0v2" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 10h14v9a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-9Z" />
        </svg>
        Private delivery straight to my inbox.
      </p>
    </div>
    
    <div data-scroll data-scroll-delay="0.1" class="opacity-0">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
        <div class="flex items-center gap-3 p-3 rounded-lg border border-secondary-accent/30 bg-base-100 shadow-sm">
          <div class="p-2 rounded-full bg-primary-accent/10 text-primary-accent">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 17a3 3 0 0 1-3-3v-2a3 3 0 1 1 6 0v2a3 3 0 0 1-3 3Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M7 10V8a5 5 0 1 1 10 0v2" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 10h14v9a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-9Z" />
            </svg>
          </div>
          <div>
            <p class="text-sm font-semibold">Private delivery</p>
            <p class="text-xs text-secondary-accent">Only I see what you share.</p>
          </div>
        </div>
        <div class="flex items-center gap-3 p-3 rounded-lg border border-secondary-accent/30 bg-base-100 shadow-sm">
          <div class="p-2 rounded-full bg-primary-accent/10 text-primary-accent">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 10h6" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 6h6" />
            </svg>
          </div>
          <div>
            <p class="text-sm font-semibold">Friendly tone</p>
            <p class="text-xs text-secondary-accent">Feel free to be informal.</p>
          </div>
        </div>
        <div class="flex items-center gap-3 p-3 rounded-lg border border-secondary-accent/30 bg-base-100 shadow-sm">
          <div class="p-2 rounded-full bg-primary-accent/10 text-primary-accent">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-6" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M7 9.6 4.5 12A2 2 0 0 0 4.09 14l1.1 4.4A2 2 0 0 0 7.11 20H16.9a2 2 0 0 0 1.91-1.6l1.1-4.4A2 2 0 0 0 19.5 12L17 9.6a2 2 0 0 0-1.44-.6H8.44a2 2 0 0 0-1.44.6Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3a4 4 0 0 0-4 4v2h8V7a4 4 0 0 0-4-4Z" />
            </svg>
          </div>
          <div>
            <p class="text-sm font-semibold">Human reply</p>
            <p class="text-xs text-secondary-accent">You'll hear from me, not a bot.</p>
          </div>
        </div>
      </div>

      <form id="letterForm" class="bg-base-200 p-6 md:p-8 rounded-xl shadow-lg border border-secondary-accent/20">
        <div class="form-control mb-5">
          <label class="label" for="name">
            <span class="label-text flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="text-primary-accent">
                <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
              </svg>
              Who's writing? (optional)
            </span>
          </label>
          <input type="text" id="name" class="input input-bordered w-full bg-base-100" placeholder="Your name or stay anonymous..." />
        </div>
        
        <div class="form-control mb-6">
          <label class="label" for="message">
            <span class="label-text flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="text-primary-accent">
                <path d="M2 2a2 2 0 0 0-2 2v8.01a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2zm.5 3a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zm2 0a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zm-2 7a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zm2 0a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zM12 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
              </svg>
              Your Message
            </span>
            <span class="label-text-alt text-secondary-accent flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 17h.01" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 5a7 7 0 1 1-7 7 7 7 0 0 1 7-7Z" />
              </svg>
              Required
            </span>
          </label>
          <textarea 
            id="message" 
            rows="8" 
            class="textarea textarea-bordered w-full bg-base-100" 
            placeholder="Dear friend, I wanted to tell you..." 
            maxlength="600"
            required
          ></textarea>
          <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between text-xs text-secondary-accent mt-2">
            <span class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 7h6m-6 4h14m-14 4h10" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 5v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.5a2 2 0 0 1 1.4.58l4.5 4.42A2 2 0 0 1 19 9.4Z" />
              </svg>
              Share a story, feedback, or a quick hello.
            </span>
            <span id="messageCounter" class="flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-9-9" />
              </svg>
              0/600
            </span>
          </div>
        </div>
        
        <button 
          type="submit" 
          class="btn btn-primary w-full group relative overflow-hidden"
          id="submitButton"
        >
          <span class="absolute inset-0 w-full h-full transition-all duration-300 ease-out transform translate-x-0 -skew-x-12 bg-primary-accent group-hover:skew-x-12"></span>
          <span class="absolute inset-0 w-full h-full transition-all duration-300 ease-out transform skew-x-12 bg-secondary-accent group-hover:-skew-x-12"></span>
          <span id="submitText" class="relative flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            Send Your Note
          </span>
          <span id="loadingSpinner" class="loading loading-spinner loading-md hidden"></span>
        </button>
        
        <p class="text-xs mt-4 text-center opacity-70">
          Your note will be delivered straight to me, and nobody else will see it.
        </p>
      </form>
    </div>
    
    <div id="successMessage" data-scroll data-scroll-delay="0.2" class="opacity-0 mt-8 p-6 bg-success/10 border border-success/30 rounded-xl text-center hidden">
      <div class="flex justify-center mb-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-success">
          <path d="M22 2L11 13"></path>
          <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-success mb-2">Your Note Has Been Sent!</h3>
      <p>Thank you for your sweet message! I'll read it soon and treasure your thoughts.</p>
      <button id="writeAnother" class="btn btn-outline btn-success mt-4">Write Another Note</button>
    </div>

    <div id="errorMessage" data-scroll data-scroll-delay="0.2" class="opacity-0 mt-8 p-6 bg-error/10 border border-error/30 rounded-xl text-center hidden">
      <h3 class="text-xl font-bold text-error mb-2">Oh no! Something went wrong</h3>
      <p>There was a tiny hiccup sending your note. Please try again in a moment.</p>
      <button id="tryAgain" class="btn btn-outline btn-error mt-4">Try Again</button>
    </div>
  </section>

  <script>
    import { addLetter } from '../utils/firebaseConfig';

    document.addEventListener('DOMContentLoaded', () => {
      const MAX_MESSAGE_LENGTH = 600;
      const submitDefaultContent = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
          Send Your Note
        `;

      const form = document.getElementById('letterForm') as HTMLFormElement | null;
      const nameInput = document.getElementById('name') as HTMLInputElement | null;
      const messageInput = document.getElementById('message') as HTMLTextAreaElement | null;
      const submitButton = document.getElementById('submitButton') as HTMLButtonElement | null;
      const submitText = document.getElementById('submitText') as HTMLSpanElement | null;
      const loadingSpinner = document.getElementById('loadingSpinner') as HTMLSpanElement | null;
      const successMessage = document.getElementById('successMessage') as HTMLDivElement | null;
      const errorMessage = document.getElementById('errorMessage') as HTMLDivElement | null;
      const messageCounter = document.getElementById('messageCounter') as HTMLSpanElement | null;

      const updateMessageCounter = () => {
        if (!messageInput || !messageCounter) return;
        const length = messageInput.value.length;
        messageCounter.textContent = `${length}/${MAX_MESSAGE_LENGTH}`;
        messageCounter.classList.toggle('text-error', length >= MAX_MESSAGE_LENGTH);
      };

      messageInput?.addEventListener('input', updateMessageCounter);
      updateMessageCounter();

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!messageInput || !submitButton || !submitText || !loadingSpinner || !successMessage || !errorMessage) {
          return;
        }

        const name = nameInput?.value.trim() || '';
        const message = messageInput.value.trim();

        if (!message) {
          messageInput.focus();
          return;
        }

        try {
          submitButton.disabled = true;
          submitText.textContent = "Sending...";
          loadingSpinner.classList.remove("hidden");
          
          await addLetter({ name, message });
          
          form.classList.add('hidden');
          successMessage.classList.remove('hidden');
          errorMessage.classList.add('hidden');
          
          form.reset();
          updateMessageCounter();
        } catch (error) {
          console.error('Error sending letter:', error);
          
          errorMessage.classList.remove('hidden');
          form.classList.remove('hidden');
        } finally {
          submitButton.disabled = false;
          submitText.innerHTML = submitDefaultContent;
          loadingSpinner.classList.add("hidden");
        }
      });
      
      document.getElementById('writeAnother')?.addEventListener('click', () => {
        form?.classList.remove('hidden');
        successMessage?.classList.add('hidden');
        errorMessage?.classList.add('hidden');
        messageInput?.focus();
      });
      
      document.getElementById('tryAgain')?.addEventListener('click', () => {
        errorMessage?.classList.add('hidden');
        form?.classList.remove('hidden');
        messageInput?.focus();
      });

      const scrollElements = document.querySelectorAll('[data-scroll]');
      
      const elementInView = (el, scrollOffset = 0) => {
        const elementTop = el.getBoundingClientRect().top;
        return (
          elementTop <= 
          (window.innerHeight || document.documentElement.clientHeight) * 0.8
        );
      };
      
      const displayScrollElement = (element) => {
        const delay = element.dataset.scrollDelay || 0;
        setTimeout(() => {
          element.classList.add('motion-safe:animate-fadeIn');
          element.style.opacity = 1;
          element.style.transform = 'translateY(0)';
        }, delay * 1000);
      };
      
      const hideScrollElement = (element) => {
        element.style.opacity = 0;
        element.style.transform = 'translateY(20px)';
      };
      
      const handleScrollAnimation = () => {
        scrollElements.forEach((el) => {
          if (elementInView(el, 100)) {
            displayScrollElement(el);
          } else {
            hideScrollElement(el);
          }
        });
      };
      
      scrollElements.forEach(el => {
        el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
      });
      
      window.addEventListener('scroll', () => {
        handleScrollAnimation();
      });
      
      handleScrollAnimation();
    });
  </script>
</BaseLayout>

<style>
  [data-scroll] {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease, transform 0.6s ease;
  }
</style>
